default_platform(:ios)

platform :ios do
  desc "Build iOS app"
  lane :build do |options|
    version_name = options[:version]
    match = version_name.match(/(\d+\.\d+\.\d+)/)
    sanitized_version = match ? match[1] : "1.0.0"

    build_number = options[:build_number]
    unless build_number
      begin
        build_number = latest_testflight_build_number(
          api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"]
        ) + 1
      rescue => e
        UI.message("Failed to get build number from TestFlight, defaulting to 1. Error: #{e.message}")
        build_number = 1
      end
    end

    UI.message("Building version #{version_name} (#{build_number})")

## .  The following API does not make any effect in case GENERATE_INFOPLIST_FILE = true
#     increment_version_number(
#       version_number: sanitized_version,
#       xcodeproj: "iosApp/iosApp.xcodeproj"
#     )
#
#     increment_build_number(
#       build_number: build_number,
#       xcodeproj: "iosApp/iosApp.xcodeproj"
#     )

    ENV["VERSION_NAME"] = version_name

    signing_settings = {
      team_id: ENV.fetch('DEVELOPMENT_TEAM'),
      profile: ENV.fetch("PROVISIONING_PROFILE_SPECIFIER"),
      identity: "Apple Distribution"
    }

    build_app(
      project: "iosApp/iosApp.xcodeproj",
      scheme: "iosApp",
      output_directory: "iosApp/build",
      output_name: "JUFK.ipa",
      export_method: "app-store",
      xcargs: [
          "DEVELOPMENT_TEAM=#{signing_settings[:team_id]}",
          "CODE_SIGN_STYLE=Manual",
          "CODE_SIGN_IDENTITY='#{signing_settings[:identity]}'",
          "PROVISIONING_PROFILE_SPECIFIER='#{signing_settings[:profile]}'",
          "MARKETING_VERSION=#{sanitized_version}",
          "CURRENT_PROJECT_VERSION=#{build_number}"
        ].join(" "),
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier) => signing_settings[:profile]
        }
      }
    )

    lane_context[:VERSION_NAME] = version_name
    lane_context[:BUILD_NUMBER] = build_number
  end

  desc "Deploy to TestFlight"
  lane :testflight_upload do |options|
    build(version: options[:version])
    upload_to_testflight(
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
      skip_waiting_for_build_processing: true
    )
  end

  desc "Deploy to App Store"
  lane :release do |options|
    build(version: options[:version])
    upload_to_app_store(
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: false
    )
  end
end

platform :android do
  def fetch_next_play_store_version_code
    tracks = %w[internal alpha beta production]
    all_version_codes = []

    tracks.each do |track|
      begin
        codes = google_play_track_version_codes(
          track: track,
          json_key_data: ENV["PLAY_SERVICE_ACCOUNT_JSON"]
        )
        all_version_codes.concat(codes) if codes
      rescue => e
        UI.message("Skipping track #{track}: #{e.message}")
      end
    end

    (all_version_codes.max || 0) + 1
  end

  desc "Build Android app"
  lane :build do |options|
    version_name = options[:version] || "1.0.0"

    begin
      version_code = fetch_next_play_store_version_code
    rescue => e
      UI.error("Failed to get version code from Play Store, defaulting to 1. Error: #{e.message}")
      version_code = 1
    end # Fix: Added missing end

    UI.message("Building Android version #{version_name} (#{version_code})")

    gradle(
      task: "bundle",
      build_type: "Release",
      properties: (options[:gradle_properties] || {}).merge({
        "VERSION_NAME" => version_name,
        "VERSION_CODE" => version_code.to_s
      })
    )
  end

  desc "Deploy to a specific Play Store track"
  private_lane :deploy_to_track do |options|
    build(version: options[:version])

    upload_to_play_store(
      track: options[:track],
      # Recommendation: Use the path from the gradle action output
      aab: lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH],
      json_key_data: ENV["PLAY_SERVICE_ACCOUNT_JSON"]
    )
  end

  desc "Deploy to Play Store internal track"
  lane :internal do |options|
    deploy_to_track(track: "internal", version: options[:version])
  end

  desc "Deploy to Play Store alpha track"
  lane :alpha do |options|
    deploy_to_track(track: "alpha", version: options[:version])
  end

  desc "Deploy to Play Store beta track"
  lane :beta do |options|
    deploy_to_track(track: "beta", version: options[:version])
  end

  desc "Deploy to Play Store production"
  lane :production do |options|
    deploy_to_track(track: "production", version: options[:version])
  end
end
