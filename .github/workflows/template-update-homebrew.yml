name: Update Homebrew Formula

on:
  workflow_call:
    inputs:
      version:
        description: 'Version string (e.g., 1.2.3)'
        required: true
        type: string
      tag:
        description: 'Git tag (e.g., v1.2.3)'
        required: true
        type: string
    secrets:
      HOMEBREW_TAP_PRIVATE_KEY:
        required: true

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Download CLI artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compute SHA256 hashes
        id: hashes
        run: |
          SHA_MACOS_ARM64=$(sha256sum artifacts/jufk-macos-arm64/jufk-macos-arm64 | cut -d' ' -f1)
          SHA_MACOS_X64=$(sha256sum artifacts/jufk-macos-x64/jufk-macos-x64 | cut -d' ' -f1)
          SHA_LINUX_X64=$(sha256sum artifacts/jufk-linux-x64/jufk-linux-x64 | cut -d' ' -f1)

          echo "macos_arm64=$SHA_MACOS_ARM64" >> $GITHUB_OUTPUT
          echo "macos_x64=$SHA_MACOS_X64" >> $GITHUB_OUTPUT
          echo "linux_x64=$SHA_LINUX_X64" >> $GITHUB_OUTPUT

          echo "Computed hashes:"
          echo "  macOS ARM64: $SHA_MACOS_ARM64"
          echo "  macOS x64: $SHA_MACOS_X64"
          echo "  Linux x64: $SHA_LINUX_X64"

      - name: Setup SSH key for homebrew tap
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOMEBREW_TAP_PRIVATE_KEY }}

      - name: Clone homebrew tap
        run: |
          git clone --depth 1 git@github.com:adjorno/homebrew-jufk.git homebrew-jufk

      - name: Update formula
        run: |
          VERSION="${{ inputs.version }}"

          cd homebrew-jufk

          # Update version
          sed -i "s/version \".*\"/version \"$VERSION\"/" Formula/jufk.rb

          # Update macOS ARM64
          sed -i "s|url \".*jufk-macos-arm64\"|url \"https://github.com/adjorno/just-use-fucking-kotlin/releases/download/v$VERSION/jufk-macos-arm64\"|" Formula/jufk.rb
          sed -i "/jufk-macos-arm64/{n;s/sha256 \".*\"/sha256 \"${{ steps.hashes.outputs.macos_arm64 }}\"/}" Formula/jufk.rb

          # Update macOS x64
          sed -i "s|url \".*jufk-macos-x64\"|url \"https://github.com/adjorno/just-use-fucking-kotlin/releases/download/v$VERSION/jufk-macos-x64\"|" Formula/jufk.rb
          sed -i "/jufk-macos-x64/{n;s/sha256 \".*\"/sha256 \"${{ steps.hashes.outputs.macos_x64 }}\"/}" Formula/jufk.rb

          # Update Linux x64
          sed -i "s|url \".*jufk-linux-x64\"|url \"https://github.com/adjorno/just-use-fucking-kotlin/releases/download/v$VERSION/jufk-linux-x64\"|" Formula/jufk.rb
          sed -i "/jufk-linux-x64/{n;s/sha256 \".*\"/sha256 \"${{ steps.hashes.outputs.linux_x64 }}\"/}" Formula/jufk.rb

          echo "Updated formula:"
          cat Formula/jufk.rb

      - name: Commit and push formula
        run: |
          cd homebrew-jufk
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/jufk.rb
          git commit -m "Update Homebrew formula for ${{ inputs.tag }}"
          git push
